<!DOCTYPE html>
<html>

<head>
    <title>GPS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 360px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 30px;
            min-height: 48px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #f87171;
        }

        .btn {
            display: inline-block;
            padding: 14px 32px;
            background: white;
            color: #764ba2;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .hidden {
            display: none;
        }

        .info {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="icon" id="icon">ğŸ“</div>
        <div class="title" id="title">ìœ„ì¹˜ í™•ì¸ ì¤‘</div>
        <div id="spinnerWrap">
            <div class="spinner"></div>
        </div>
        <div class="status" id="status">GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
        <div id="buttons" class="hidden">
            <button class="btn" id="closeBtn" onclick="closeWindow()">ë‹«ê¸°</button>
            <button class="btn btn-secondary hidden" id="retryBtn" onclick="getLocation()">ë‹¤ì‹œ ì‹œë„</button>
        </div>
        <div class="info" id="info"></div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vtsttqtbewxkxxdoyhrj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0c3R0cXRiZXd4a3h4ZG95aHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxOTcwNTUsImV4cCI6MjA4NDc3MzA1NX0.EfWnp7xfRNLKnpvFyEzqrVMfewU-7C4cxPHIO_sp5r0';

        // Get request ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('rid');

        function closeWindow() {
            window.close();
            // If window.close() doesn't work (some browsers block it)
            setTimeout(function () {
                document.getElementById('info').innerHTML =
                    'ì°½ì´ ìë™ìœ¼ë¡œ ë‹«íˆì§€ ì•Šìœ¼ë©´<br>ì§ì ‘ ë‹«ê³  ì›ë˜ ì•±ìœ¼ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.';
            }, 500);
        }

        async function saveToSupabase(data) {
            if (!requestId) {
                console.error('No request ID');
                // Fallback to localStorage
                localStorage.setItem('gps_result', JSON.stringify(data));
                return false;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/gps_requests?id=eq.${requestId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    console.error('Supabase error:', response.status, await response.text());
                    // Fallback to localStorage
                    localStorage.setItem('gps_result', JSON.stringify(data));
                    return false;
                }
                return true;
            } catch (err) {
                console.error('Network error:', err);
                localStorage.setItem('gps_result', JSON.stringify(data));
                return false;
            }
        }

        function showSuccess(lat, lng, savedToDb) {
            document.getElementById('icon').textContent = 'âœ…';
            document.getElementById('title').textContent = 'ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
            document.getElementById('title').className = 'title success';
            document.getElementById('status').innerHTML =
                'ìœ„ë„: ' + lat.toFixed(6) + '<br>ê²½ë„: ' + lng.toFixed(6);
            document.getElementById('spinnerWrap').classList.add('hidden');
            document.getElementById('buttons').classList.remove('hidden');
            document.getElementById('closeBtn').classList.remove('hidden');

            if (savedToDb) {
                document.getElementById('info').innerHTML =
                    'ìœ„ì¹˜ ì •ë³´ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ ì°½ì„ ë‹«ê³  ì›ë˜ ì•±ìœ¼ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.';
            } else {
                document.getElementById('info').innerHTML =
                    'ì´ ì°½ì„ ë‹«ê³  ì›ë˜ ì•±ìœ¼ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.';
            }

            // Try to auto-close after 2 seconds
            setTimeout(closeWindow, 2000);
        }

        function showError(message, code) {
            document.getElementById('icon').textContent = 'âŒ';
            document.getElementById('title').textContent = 'ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
            document.getElementById('title').className = 'title error';

            var msg = message;
            if (code === 1) {
                msg = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>Safari ì„¤ì • > ê°œì¸ì •ë³´ ë³´í˜¸ > ìœ„ì¹˜ ì„œë¹„ìŠ¤ì—ì„œ<br>ì´ ì‚¬ì´íŠ¸ì˜ ìœ„ì¹˜ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
            } else if (code === 2) {
                msg = 'ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>GPS ì‹ í˜¸ê°€ ì•½í•˜ê±°ë‚˜ ì‹¤ë‚´ì— ê³„ì‹  ê²½ìš°<br>ì°½ê°€ë¡œ ì´ë™í•´ë³´ì„¸ìš”.';
            } else if (code === 3) {
                msg = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }

            document.getElementById('status').innerHTML = msg;
            document.getElementById('spinnerWrap').classList.add('hidden');
            document.getElementById('buttons').classList.remove('hidden');
            document.getElementById('closeBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.remove('hidden');
        }

        async function getLocation() {
            // Reset UI
            document.getElementById('icon').textContent = 'ğŸ“';
            document.getElementById('title').textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘';
            document.getElementById('title').className = 'title';
            document.getElementById('status').textContent = 'GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...';
            document.getElementById('spinnerWrap').classList.remove('hidden');
            document.getElementById('buttons').classList.add('hidden');
            document.getElementById('info').textContent = '';

            // 1. Check for Secure Context (HTTPS requirement)
            const isSecure = window.isSecureContext || window.location.protocol === 'https:' ||
                window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            if (!isSecure) {
                const insecureMsg = 'í˜„ì¬ ë³´ì•ˆ ì—°ê²°(HTTPS)ì´ ì•„ë‹™ë‹ˆë‹¤.<br><br>' +
                    'ì‚¬íŒŒë¦¬/í¬ë¡¬ ë“± ìµœì‹  ë¸Œë¼ìš°ì €ëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ<br>' +
                    '<b>HTTP(ë³´ì•ˆ ì•ˆ ë¨)</b> í™˜ê²½ì—ì„œ GPS ì‚¬ìš©ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.<br><br>' +
                    'í•´ê²°: https ì£¼ì†Œë¡œ ì ‘ì†í•˜ê±°ë‚˜ ë„¤ì´í‹°ë¸Œ ì•±ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                await saveToSupabase({
                    status: 'error',
                    error_message: 'Insecure Context (HTTP)'
                });
                showError(insecureMsg, 0);
                return;
            }

            if (!navigator.geolocation) {
                await saveToSupabase({
                    status: 'error',
                    error_message: 'GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤'
                });
                showError('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤', 0);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async function (position) {
                    const data = {
                        status: 'completed',
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        updated_at: new Date().toISOString()
                    };

                    const saved = await saveToSupabase(data);
                    showSuccess(data.lat, data.lng, saved);
                },
                async function (error) {
                    await saveToSupabase({
                        status: 'error',
                        error_message: error.message || 'Unknown error',
                        updated_at: new Date().toISOString()
                    });
                    showError(error.message, error.code);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // Start on page load
        if (requestId) {
            document.getElementById('info').textContent = 'Request ID: ' + requestId;
        }
        getLocation();
    </script>
</body>

</html>