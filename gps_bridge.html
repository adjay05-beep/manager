<!DOCTYPE html>
<html>

<head>
    <title>GPS Pulse Bridge</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: #121212;
            color: white;
        }

        .card {
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 1rem;
            width: 85%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #333;
        }
    </style>
</head>

<body>
    <div class="card">
        <div id="status">ğŸ›°ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì €ì¥ì†Œì— ê¸°ë¡ ì¤‘...</div>
    </div>

    <script>
        async function run() {
            if (!navigator.geolocation) {
                saveData({ error: 'GPSì§€ì›ì•ˆí•¨' });
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (p) => {
                    saveData({
                        lat: p.coords.latitude,
                        lng: p.coords.longitude,
                        ts: Date.now()
                    });
                },
                (e) => {
                    saveData({ error: e.message });
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function saveData(data) {
            const status = document.getElementById('status');
            const json = JSON.stringify(data);

            // ì—¬ëŸ¬ í‚¤ì— ì €ì¥í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´
            localStorage.setItem('flet_gps_data', json);
            localStorage.setItem('flet_gps_result', json);

            // Flet client_storage í˜¸í™˜ í‚¤ (ft. prefix)
            try {
                localStorage.setItem('ft.flet_gps_data', json);
                localStorage.setItem('ft.flet_gps_result', json);
            } catch(e) {}

            // ë¶€ëª¨ ì°½ì— postMessageë¡œ ì „ë‹¬ ì‹œë„
            try {
                if (window.opener) {
                    window.opener.postMessage({type: 'GPS_RESULT', data: data}, '*');
                }
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({type: 'GPS_RESULT', data: data}, '*');
                }
            } catch(e) {}

            status.innerHTML = "<b style='color:#0f0'>ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ!</b><br>ì ì‹œ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤...";

            // 1.5ì´ˆ í›„ ë‹«ê¸°
            setTimeout(() => {
                window.close();
            }, 1500);
        }

        run();
    </script>
</body>

</html>